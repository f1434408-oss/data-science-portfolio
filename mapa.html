<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>BASE CONTROL PC 2026 - PAE</title>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: #111;
}

#panel {
    position: absolute;
    width: 360px;
    height: 100%;
    background: linear-gradient(180deg, #111 0%, #1b1b1b 100%);
    color: white;
    padding: 32px;
    z-index: 2;
    font-size: 16px;
    line-height: 1.7;
}

#map {
    position: absolute;
    left: 360px;
    width: calc(100% - 360px);
    height: 100%;
}

.mapboxgl-popup-content {
    background: #1c1c1c;
    color: white;
    border-radius: 14px;
    font-size: 16px;
    padding: 20px;
}

</style>
</head>

<body>

<div id="panel">
    <h1>BASE CONTROL PC 2026 - PAE</h1>
    <h2>PE Estad√≠stica Nacional</h2>

    <p>
        <strong>IIEE:</strong> 67,055<br>
        <strong>Usuarios:</strong> 4,187,782<br>
        <strong>√çtems:</strong> 711
    </p>
</div>

<div id="map"></div>

<script>

mapboxgl.accessToken = "pk.eyJ1IjoiMjAxODE3MjUiLCJhIjoiY21sanZ1NmdzMDQ5czNrcHFwdXBpN3o2eCJ9.lM43dWvXvojawo82gZFOIw";

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [-74.8, -9.3],
    zoom: 5.4
});

let popup;

map.on('load', function () {

    map.setPaintProperty('water', 'fill-color', '#3fa9f5');

    // üîµ SOURCE EST√âTICO (DIVIDIDO)
    map.addSource('departamentos-div', {
        type: 'geojson',
        data: 'geo_pae_departamental_dividido.geojson'
    });

    // üü¢ SOURCE INDICADORES (ORIGINAL)
    map.addSource('departamentos-info', {
        type: 'geojson',
        data: 'geo_pae_departamental.geojson'
    });

    const colorExpression = [
        'match',
        ['get', 'TIPO'],
        'CONTRATO', '#27AE60',
        'ADJUDICADO', '#F1C40F',
        'INVITACION', '#E74C3C',
        '#ccc'
    ];

    // CAPA BASE
    map.addLayer({
        id: 'fill-layer',
        type: 'fill',
        source: 'departamentos-div',
        paint: {
            'fill-color': colorExpression,
            'fill-opacity': 0.9
        }
    });

    map.addLayer({
        id: 'border-layer',
        type: 'line',
        source: 'departamentos-div',
        paint: {
            'line-color': 'rgba(255,255,255,0.4)',
            'line-width': 1.2
        }
    });

    // SOURCE PARA HOVER AGRANDADO
    map.addSource('hover-source', {
        type: 'geojson',
        data: { type: "FeatureCollection", features: [] }
    });

    map.addLayer({
        id: 'hover-fill',
        type: 'fill',
        source: 'hover-source',
        paint: {
            'fill-color': colorExpression,
            'fill-opacity': 1
        }
    });

    map.addLayer({
        id: 'hover-border',
        type: 'line',
        source: 'hover-source',
        paint: {
            'line-color': '#ffffff',
            'line-width': 5
        }
    });

    // FUNCI√ìN ESCALAR (Polygon y MultiPolygon)
    function scaleFeature(feature, scale) {

        const clone = JSON.parse(JSON.stringify(feature));

        function scaleCoords(coords) {

            let cx = 0, cy = 0, total = 0;

            coords.forEach(ring => {
                ring.forEach(p => {
                    cx += p[0];
                    cy += p[1];
                    total++;
                });
            });

            cx /= total;
            cy /= total;

            return coords.map(ring =>
                ring.map(p => [
                    cx + (p[0] - cx) * scale,
                    cy + (p[1] - cy) * scale
                ])
            );
        }

        if (clone.geometry.type === "Polygon") {
            clone.geometry.coordinates = scaleCoords(clone.geometry.coordinates);
        }

        if (clone.geometry.type === "MultiPolygon") {
            clone.geometry.coordinates = clone.geometry.coordinates.map(poly =>
                scaleCoords(poly)
            );
        }

        return clone;
    }

    map.on('mousemove', 'fill-layer', function (e) {

        const departamento = e.features[0].properties.NOMBDEP;

        // üî• AUMENTO FUERTE COMO ORIGINAL
        const scaled = scaleFeature(e.features[0], 1.9);

        map.getSource('hover-source').setData({
            type: "FeatureCollection",
            features: [scaled]
        });

        const features = map.querySourceFeatures('departamentos-info', {
            filter: ['==', ['get', 'NOMBDEP'], departamento]
        });

        const props = features[0].properties;

        if (popup) popup.remove();

        popup = new mapboxgl.Popup({ offset: 25 })
            .setLngLat(e.lngLat)
            .setHTML(`
                <b style="font-size:18px;">${departamento}</b>
                <hr style="opacity:0.3;">
                <b>√çtems:</b> ${props.ITEMS_TOTAL}<br>
                <b>IIEE:</b> ${props.IIEE_TOTAL}<br>
                <b>Usuarios:</b> ${props.USUARIOS_FMT}<br><br>
                <b>% Contrato:</b> ${props.CONTRATO}%<br>
                <b>% Adjudicado:</b> ${props.ADJUDICADO}%<br>
                <b>% En Invitaci√≥n:</b> ${props["EN INVITACI√ìN"]}%<br><br>

                <div style="text-align:center;">
                    <a href="detalle.html?dep=${encodeURIComponent(departamento)}"
                       style="
                            display:inline-block;
                            padding:8px 14px;
                            background:#27AE60;
                            color:white;
                            text-decoration:none;
                            border-radius:6px;
                            font-weight:600;
                       ">
                       Ver detalle ‚Üí
                    </a>
                </div>
            `)
            .addTo(map);
    });

    map.on('mouseleave', 'fill-layer', function () {
        map.getSource('hover-source').setData({
            type: "FeatureCollection",
            features: []
        });
        if (popup) popup.remove();
    });

});
</script>

</body>
</html>