<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
<script src="https://unpkg.com/@deck.gl/geo-layers@latest/dist.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
body { margin: 0; font-family: 'Segoe UI', sans-serif; }

#panel {
  position: absolute;
  left: 0;
  top: 0;
  width: 320px;
  height: 100%;
  background: rgba(20,20,20,0.96);
  color: white;
  padding: 24px;
  z-index: 10;
  box-shadow: 4px 0 20px rgba(0,0,0,0.6);
}

#map {
  position: absolute;
  left: 320px;
  width: calc(100% - 320px);
  height: 100%;
}

h2 {
  margin-top: 0;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.tooltip {
  background: rgba(20,20,20,0.92);
  color: white;
  padding: 14px;
  border-radius: 8px;
  font-size: 13px;
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);
}
</style>
</head>

<body>

<div id="panel">
  <h2>PE Estad√≠stica Nacional</h2>

  <b>IIEE:</b> 67,055<br>
  <b>Usuarios:</b> 4,187,782<br>
  <b>√çtems:</b> 711<br>

  <hr style="border-color: rgba(255,255,255,0.1);">

  <b>Estado:</b><br>
  ‚Ä¢ CONTRATO: 38%<br>
  ‚Ä¢ ADJUDICADO: 20%<br>
  ‚Ä¢ EN INVITACI√ìN: 43%<br><br>

  <b>Modalidad:</b><br>
  ‚Ä¢ COMIDA CALIENTE: 74%<br>
  ‚Ä¢ COMIDA LISTA PARA CONSUMO: 26%
</div>

<div id="map"></div>

<script>

// üî• PEGA TU TOKEN DE MAPBOX AQU√ç
const MAPBOX_TOKEN = "pk.eyJ1IjoiMjAxODE3MjUiLCJhIjoiY21sanZ1NmdzMDQ5czNrcHFwdXBpN3o2eCJ9.lM43dWvXvojawo82gZFOIw";

let hoveredFeature = null;

// üé® Paleta refinada institucional
function getColor(pct) {
  if (pct <= 33) return [166, 25, 46];   // rojo profundo
  if (pct <= 66) return [230, 159, 0];   // √°mbar elegante
  return [0, 114, 57];                   // verde institucional
}

// üî• Calcular centroide
function getCentroid(coords) {
  let x = 0, y = 0, count = 0;

  coords[0].forEach(point => {
    x += point[0];
    y += point[1];
    count++;
  });

  return [x / count, y / count];
}

// üî• Escalar pol√≠gono horizontalmente
function scalePolygon(feature, scaleFactor) {
  const newFeature = JSON.parse(JSON.stringify(feature));
  const coords = newFeature.geometry.coordinates;
  const centroid = getCentroid(coords);

  newFeature.geometry.coordinates = coords.map(ring =>
    ring.map(point => [
      centroid[0] + (point[0] - centroid[0]) * scaleFactor,
      centroid[1] + (point[1] - centroid[1]) * scaleFactor
    ])
  );

  return newFeature;
}

fetch('geo_pae_departamental.geojson')
  .then(response => response.json())
  .then(data => {

    const deckgl = new deck.Deck({
      container: 'map',
      mapboxAccessToken: MAPBOX_TOKEN,
      mapStyle: "mapbox://styles/mapbox/dark-v10",
      initialViewState: {
        longitude: -75.02,
        latitude: -9.19,
        zoom: 5,
        pitch: 45
      },
      controller: true,
      layers: [],
      getTooltip: ({object}) => object && {
        html: `
          <div class="tooltip">
            <b style="font-size:16px;">${object.properties.NOMBDEP}</b>
            <hr style="border-color: rgba(255,255,255,0.1);">

            <b>√çtems:</b> ${object.properties.ITEMS_TOTAL}<br>
            <b>% Contrato:</b> ${object.properties.CONTRATO}%<br>
            <b>% Adjudicado:</b> ${object.properties.ADJUDICADO}%<br>
            <b>% En Invitaci√≥n:</b> ${object.properties["EN INVITACI√ìN"]}%<br>

            <br>

            <b>IIEE:</b> ${object.properties.IIEE_TOTAL}<br>
            <b>Usuarios:</b> ${object.properties.USUARIOS_FMT}
          </div>
        `
      }
    });

    function updateLayers() {

      const baseLayer = new deck.GeoJsonLayer({
        id: 'base-layer',
        data: data,
        pickable: true,
        filled: true,
        extruded: false,
        getFillColor: d => {
          const c = getColor(d.properties.CONTRATO);

          if (hoveredFeature && d.properties.NOMBDEP !== hoveredFeature.properties.NOMBDEP) {
            return [c[0], c[1], c[2], 90]; // fade del resto
          }

          return [c[0], c[1], c[2], 210];
        },
        getLineColor: [200,200,200],
        lineWidthMinPixels: 0.8,
        onHover: info => {
          hoveredFeature = info.object;
          updateLayers();
        }
      });

      const hoverLayer = hoveredFeature
        ? new deck.GeoJsonLayer({
            id: 'hover-layer',
            data: scalePolygon(hoveredFeature, 2.2), // üî• crecimiento fuerte
            filled: true,
            extruded: false,
            getFillColor: getColor(hoveredFeature.properties.CONTRATO),
            getLineColor: [255,255,255],
            lineWidthMinPixels: 2
          })
        : null;

      deckgl.setProps({
        layers: hoverLayer
          ? [baseLayer, hoverLayer]
          : [baseLayer]
      });
    }

    updateLayers();

  });

</script>

</body>
</html>
