<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>BASE CONTROL PC 2026 PAE</title>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: #111;
}

/* ================= PANEL ================= */
#panel {
    position: absolute;
    width: 420px;
    height: 100%;
    background: linear-gradient(180deg, #111 0%, #1b1b1b 100%);
    color: white;
    padding: 50px;
    z-index: 1;
    font-size: 24px;
    line-height: 1.9;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

#panel h2 {
    font-size: 36px;
    font-weight: 700;
    letter-spacing: 1.5px;
    margin-bottom: 30px;
}

/* ================= MAPA ================= */
#map {
    position: absolute;
    left: 420px;
    width: calc(100% - 420px);
    height: 100%;
}

/* ================= POPUP ================= */
.mapboxgl-popup-content {
    background: #1c1c1c;
    color: white;
    border-radius: 18px;
    font-size: 22px;
    padding: 28px;
}

.mapboxgl-popup-tip {
    border-top-color: #1c1c1c !important;
}

/* ================= LEYENDA ================= */
.legend {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
    font-size: 22px;
}

.legend b {
    font-size: 24px;
}

.legend div {
    margin-top: 14px;
}

.legend span {
    display: inline-block;
    width: 24px;
    height: 24px;
    margin-right: 14px;
    border-radius: 4px;
}

/* ================= MODAL ================= */
#modal {
    display:none;
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.85);
    z-index:1000;
    overflow:auto;
}
#modalContent {
    background:#1b1b1b;
    color:white;
    margin:50px auto;
    padding:30px;
    border-radius:18px;
    width:90%;
    max-width:1200px;
    position:relative;
}
#closeModal {
    position:absolute;
    top:15px;
    right:15px;
    font-size:24px;
    background:none;
    border:none;
    color:white;
    cursor:pointer;
}
#modalTable {
    width:100%;
    border-collapse:collapse;
    font-size:18px;
    max-height:70vh;
    display:block;
    overflow-y:auto;
}
#modalTable thead, #modalTable tbody tr {
    display:table;
    width:100%;
    table-layout:fixed;
}
#modalTable thead {
    width:calc(100% - 1em);
}
#modalTable th, #modalTable td {
    padding:6px;
    border-bottom:1px solid #333;
    text-align:left;
}
</style>
</head>

<body>

<div id="panel">
    <div>
        <h2>BASE CONTROL PC 2026 PAE</h2>
        <p>
        <b>IIEE:</b> 67,055<br>
        <b>Usuarios:</b> 4,187,782<br>
        <b>Ítems:</b> 711
        </p>
        <hr style="opacity:0.2;">
        <p>
        <b>Estado:</b><br>
        • CONTRATO: 38%<br>
        • ADJUDICADO: 20%<br>
        • EN INVITACIÓN: 43%
        </p>
    </div>

    <!-- LEYENDA DENTRO DEL PANEL -->
    <div class="legend">
        <b>Estado Mayoritario</b>
        <div><span style="background:#27AE60;"></span>Contrato</div>
        <div><span style="background:#F1C40F;"></span>Adjudicado</div>
        <div><span style="background:#E74C3C;"></span>Invitación</div>
    </div>
</div>

<div id="map"></div>

<!-- MODAL PARA TABLA -->
<div id="modal">
    <div id="modalContent">
        <button id="closeModal">✖</button>
        <h2 id="modalTitle" style="margin-bottom:20px;"></h2>
        <table id="modalTable">
            <thead>
                <tr>
                    <th>ITEM</th>
                    <th>MODALIDAD_DCON</th>
                    <th>N° DE IIEE</th>
                    <th>N°DE USUARIOS</th>
                    <th>VALOR REFERENCIAL</th>
                    <th>VALOR ADJUDICADO</th>
                    <th>ESTADO ACTUAL ITEM</th>
                    <th>CONTRATO</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
mapboxgl.accessToken = "pk.eyJ1IjoiMjAxODE3MjUiLCJhIjoiY21sanZ1NmdzMDQ5czNrcHFwdXBpN3o2eCJ9.lM43dWvXvojawo82gZFOIw";

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [-74.8, -9.3],
    zoom: 5.4
});

let popup;

// CARGAR BASE PAE JSON
let basePAE = [];
fetch("base_pae.json")
  .then(res => res.json())
  .then(data => { basePAE = data; })
  .catch(err => console.error("Error cargando base_pae.json:", err));

const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalTableBody = document.querySelector("#modalTable tbody");
const closeModal = document.getElementById("closeModal");

closeModal.addEventListener("click", () => {
    modal.style.display = "none";
});

function showTable(departamento) {
    modalTitle.innerText = `Detalle completo - ${departamento}`;
    modalTableBody.innerHTML = "";

    const rows = basePAE.filter(d => d.DEPARTAMENTO === departamento);
    rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${r.ITEM}</td>
            <td>${r.MODALIDAD_DCON}</td>
            <td>${r["N° DE IIEE"]}</td>
            <td>${r["N°DE USUARIOS"]}</td>
            <td>${r["VALOR REFERENCIAL"]}</td>
            <td>${r["VALOR ADJUDICADO"]}</td>
            <td>${r["ESTADO ACTUAL ITEM"]}</td>
            <td>${r.CONTRATO}</td>
        `;
        modalTableBody.appendChild(tr);
    });

    modal.style.display = "block";
}

map.on('load', function () {

    map.getStyle().layers.forEach(layer => {
        if (layer.type === 'symbol') {
            map.setLayoutProperty(layer.id, 'visibility', 'none');
        }
    });

    map.setPaintProperty('water', 'fill-color', '#5dade2');

    map.addSource('departamentos', {
        type: 'geojson',
        data: 'geo_pae_departamental.geojson'
    });

    map.addSource('hover-departamento', {
        type: 'geojson',
        data: { type: "FeatureCollection", features: [] }
    });

    const colorExpression = [
        'case',
        ['all',['>=', ['get', 'CONTRATO'], ['get', 'ADJUDICADO']], ['>=', ['get', 'CONTRATO'], ['get', 'EN INVITACIÓN']]], '#27AE60',
        ['all',['>=', ['get', 'ADJUDICADO'], ['get', 'CONTRATO']], ['>=', ['get', 'ADJUDICADO'], ['get', 'EN INVITACIÓN']]], '#F1C40F',
        '#E74C3C'
    ];

    map.addLayer({
        id: 'fill-layer',
        type: 'fill',
        source: 'departamentos',
        paint: {
            'fill-color': colorExpression,
            'fill-opacity': 0.85
        }
    });

    map.addLayer({
        id: 'border-layer',
        type: 'line',
        source: 'departamentos',
        paint: {
            'line-color': 'rgba(255,255,255,0.4)',
            'line-width': 1.2
        }
    });

    function scaleFeature(feature, scale) {
        const newFeature = JSON.parse(JSON.stringify(feature));
        const coords = newFeature.geometry.coordinates[0];
        let cx=0, cy=0;
        coords.forEach(p => { cx += p[0]; cy += p[1]; });
        cx /= coords.length;
        cy /= coords.length;
        newFeature.geometry.coordinates[0] = coords.map(p => [cx + (p[0]-cx)*scale, cy + (p[1]-cy)*scale]);
        return newFeature;
    }

    map.on('mousemove', 'fill-layer', function(e) {
        const feature = e.features[0];

        if (popup) popup.remove();

        popup = new mapboxgl.Popup({ offset: 20 })
            .setLngLat(e.lngLat)
            .setHTML(`
                <b style="font-size:24px;">${feature.properties.NOMBDEP}</b>
                <hr style="opacity:0.3;">
                <b>Ítems:</b> ${feature.properties.ITEMS_TOTAL}<br><br>
                <b>Contrato:</b> ${feature.properties.CONTRATO}%<br>
                <b>Adjudicado:</b> ${feature.properties.ADJUDICADO}%<br>
                <b>Invitación:</b> ${feature.properties["EN INVITACIÓN"]}%<br><br>
                <b>IIEE:</b> ${feature.properties.IIEE_TOTAL}<br>
                <b>Usuarios:</b> ${feature.properties.USUARIOS_FMT}<br><br>
                <a href="#" id="verDetalle" style="color:#5dade2; text-decoration:underline; font-weight:bold;">Ver detalle completo</a>
            `)
            .addTo(map);

        setTimeout(() => {
            const link = document.getElementById("verDetalle");
            if (link) {
                link.addEventListener("click", ev => {
                    ev.preventDefault();
                    showTable(feature.properties.NOMBDEP);
                });
            }
        }, 50);
    });

    map.on('mouseleave', 'fill-layer', function() {
        if (popup) popup.remove();
    });

});
</script>

</body>
</html>