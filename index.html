<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Mapa PAE Per√∫</title>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: #111;
}

#panel {
    position: absolute;
    width: 320px;
    height: 100%;
    background: linear-gradient(180deg, #111 0%, #1a1a1a 100%);
    color: white;
    padding: 25px;
    z-index: 1;
}

#map {
    position: absolute;
    left: 320px;
    width: calc(100% - 320px);
    height: 100%;
}

.legend {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: rgba(20,20,20,0.9);
    padding: 15px;
    border-radius: 10px;
    font-size: 13px;
    color: white;
}

.legend span {
    display: inline-block;
    width: 12px;
    height: 12px;
    margin-right: 6px;
    border-radius: 3px;
}
</style>
</head>

<body>

<div id="panel">
    <h2>PE Estad√≠stica Nacional</h2>

    <p><b>IIEE:</b> 67,055<br>
    <b>Usuarios:</b> 4,187,782<br>
    <b>√çtems:</b> 711</p>

    <hr style="opacity:0.2;">

    <p><b>Estado:</b><br>
    ‚Ä¢ CONTRATO: 38%<br>
    ‚Ä¢ ADJUDICADO: 20%<br>
    ‚Ä¢ EN INVITACI√ìN: 43%</p>

    <hr style="opacity:0.2;">

    <p><b>Modalidad:</b><br>
    ‚Ä¢ COMIDA CALIENTE: 74%<br>
    ‚Ä¢ COMIDA LISTA PARA CONSUMO: 26%</p>
</div>

<div id="map"></div>

<div class="legend">
    <div><span style="background:#1ABC9C;"></span>Contrato</div>
    <div><span style="background:#F39C12;"></span>Invitaci√≥n</div>
    <div><span style="background:#E74C3C;"></span>Adjudicado</div>
</div>

<script>

mapboxgl.accessToken = "pk.eyJ1IjoiMjAxODE3MjUiLCJhIjoiY21sanZ1NmdzMDQ5czNrcHFwdXBpN3o2eCJ9.lM43dWvXvojawo82gZFOIw";

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [-74.8, -9.3],
    zoom: 5.4
});

map.on('load', function () {

    // üåä Mar elegante
    map.setPaintProperty('water', 'fill-color', '#0f2433');

    map.addSource('departamentos', {
        type: 'geojson',
        data: 'geo_pae_departamental.geojson'
    });

    map.addSource('hover-departamento', {
        type: 'geojson',
        data: {
            type: "FeatureCollection",
            features: []
        }
    });

    // üé® Colores ejecutivos
    function getColor(pct) {
        if (pct <= 33) return "#E74C3C";
        if (pct <= 66) return "#F39C12";
        return "#1ABC9C";
    }

    map.addLayer({
        id: 'fill-layer',
        type: 'fill',
        source: 'departamentos',
        paint: {
            'fill-color': [
                'case',
                ['<=', ['get', 'CONTRATO'], 33], '#E74C3C',
                ['<=', ['get', 'CONTRATO'], 66], '#F39C12',
                '#1ABC9C'
            ],
            'fill-opacity': 0.85
        }
    });

    map.addLayer({
        id: 'border-layer',
        type: 'line',
        source: 'departamentos',
        paint: {
            'line-color': 'rgba(255,255,255,0.4)',
            'line-width': 1
        }
    });

    map.addLayer({
        id: 'hover-layer',
        type: 'fill',
        source: 'hover-departamento',
        paint: {
            'fill-color': '#1ABC9C',
            'fill-opacity': 1
        }
    });

    // üî• Funci√≥n para escalar geometr√≠a
    function scaleFeature(feature, scale) {

        const newFeature = JSON.parse(JSON.stringify(feature));

        const coords = newFeature.geometry.coordinates[0];

        let cx = 0, cy = 0;

        coords.forEach(p => {
            cx += p[0];
            cy += p[1];
        });

        cx /= coords.length;
        cy /= coords.length;

        newFeature.geometry.coordinates[0] = coords.map(p => [
            cx + (p[0] - cx) * scale,
            cy + (p[1] - cy) * scale
        ]);

        return newFeature;
    }

    map.on('mousemove', 'fill-layer', function (e) {

        map.getCanvas().style.cursor = 'pointer';

        const feature = e.features[0];

        const scaled = scaleFeature(feature, 1.25); // üî• 25% m√°s grande

        map.getSource('hover-departamento').setData({
            type: "FeatureCollection",
            features: [scaled]
        });

        new mapboxgl.Popup({ offset: 15 })
            .setLngLat(e.lngLat)
            .setHTML(`
                <b style="font-size:16px;">${feature.properties.NOMBDEP}</b>
                <hr style="opacity:0.3;">
                <b>√çtems:</b> ${feature.properties.ITEMS_TOTAL}<br><br>
                <b>% Contrato:</b> ${feature.properties.CONTRATO}%<br>
                <b>% Adjudicado:</b> ${feature.properties.ADJUDICADO}%<br>
                <b>% En Invitaci√≥n:</b> ${feature.properties["EN INVITACI√ìN"]}%<br><br>
                <b>IIEE:</b> ${feature.properties.IIEE_TOTAL}<br>
                <b>Usuarios:</b> ${feature.properties.USUARIOS_FMT}
            `)
            .addTo(map);

    });

    map.on('mouseleave', 'fill-layer', function () {

        map.getCanvas().style.cursor = '';

        map.getSource('hover-departamento').setData({
            type: "FeatureCollection",
            features: []
        });

        const popups = document.getElementsByClassName('mapboxgl-popup');
        while(popups[0]) popups[0].remove();
    });

});
</script>

</body>
</html>
