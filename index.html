<script>
mapboxgl.accessToken = "TU_TOKEN_AQUI";

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [-74.8, -9.3],
    zoom: 5.4
});

let popup;

map.on('load', function () {

    /* üîï Ocultar etiquetas */
    map.getStyle().layers.forEach(layer => {
        if (layer.type === 'symbol') {
            map.setLayoutProperty(layer.id, 'visibility', 'none');
        }
    });

    /* üåä Color del mar */
    map.setPaintProperty('water', 'fill-color', '#0e2636');

    map.addSource('departamentos', {
        type: 'geojson',
        data: 'geo_pae_departamental.geojson'
    });

    map.addSource('hover-departamento', {
        type: 'geojson',
        data: { type: "FeatureCollection", features: [] }
    });

    const colorExpression = [
        'case',
        ['<=', ['get', 'CONTRATO'], 33], '#E74C3C',
        ['<=', ['get', 'CONTRATO'], 66], '#F1C40F',
        '#27AE60'
    ];

    /* Capa base */
    map.addLayer({
        id: 'fill-layer',
        type: 'fill',
        source: 'departamentos',
        paint: {
            'fill-color': colorExpression,
            'fill-opacity': 0.85
        }
    });

    map.addLayer({
        id: 'border-layer',
        type: 'line',
        source: 'departamentos',
        paint: {
            'line-color': 'rgba(255,255,255,0.4)',
            'line-width': 1
        }
    });

    /* Hover fill */
    map.addLayer({
        id: 'hover-fill',
        type: 'fill',
        source: 'hover-departamento',
        paint: {
            'fill-color': colorExpression,
            'fill-opacity': 1
        }
    });

    /* Hover borde */
    map.addLayer({
        id: 'hover-border',
        type: 'line',
        source: 'hover-departamento',
        paint: {
            'line-color': '#ffffff',
            'line-width': 3
        }
    });

    function scaleFeature(feature, scale) {
        const newFeature = JSON.parse(JSON.stringify(feature));
        const coords = newFeature.geometry.coordinates[0];

        let cx = 0, cy = 0;
        coords.forEach(p => {
            cx += p[0];
            cy += p[1];
        });

        cx /= coords.length;
        cy /= coords.length;

        newFeature.geometry.coordinates[0] = coords.map(p => [
            cx + (p[0] - cx) * scale,
            cy + (p[1] - cy) * scale
        ]);

        return newFeature;
    }

    map.on('mousemove', 'fill-layer', function (e) {

        const feature = e.features[0];
        const scaled = scaleFeature(feature, 2.4);

        map.getSource('hover-departamento').setData({
            type: "FeatureCollection",
            features: [scaled]
        });

        if (popup) popup.remove();

        popup = new mapboxgl.Popup({ offset: 20 })
            .setLngLat(e.lngLat)
            .setHTML(`
                <b style="font-size:18px;">${feature.properties.NOMBDEP}</b>
                <hr style="opacity:0.3;">
                <b>√çtems:</b> ${feature.properties.ITEMS_TOTAL}<br><br>
                <b>% Contrato:</b> ${feature.properties.CONTRATO}%<br>
                <b>% Adjudicado:</b> ${feature.properties.ADJUDICADO}%<br>
                <b>% En Invitaci√≥n:</b> ${feature.properties["EN INVITACI√ìN"]}%<br><br>
                <b>IIEE:</b> ${feature.properties.IIEE_TOTAL}<br>
                <b>Usuarios:</b> ${feature.properties.USUARIOS_FMT}
            `)
            .addTo(map);
    });

    map.on('mouseleave', 'fill-layer', function () {
        map.getSource('hover-departamento').setData({
            type: "FeatureCollection",
            features: []
        });
        if (popup) popup.remove();
    });

});
</script>