<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>BASE CONTROL PC 2026 PAE</title>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: #111;
}

/* ================= PANEL ================= */

#panel {
    position: absolute;
    width: 420px;
    height: 100%;
    background: linear-gradient(180deg, #111 0%, #1b1b1b 100%);
    color: white;
    padding: 32px;
    z-index: 1;
    font-size: 17px;
    line-height: 1.5;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

#panel h2 {
    font-size: 26px;
    margin-bottom: 18px;
}

#panel hr {
    margin: 18px 0;
    opacity: 0.15;
}

/* ================= MAPA ================= */

#map {
    position: absolute;
    left: 420px;
    width: calc(100% - 420px);
    height: 100%;
}

/* ================= POPUP ================= */

.mapboxgl-popup-content {
    background: #1c1c1c;
    color: white;
    border-radius: 18px;
    font-size: 22px;
    padding: 28px;
}

.mapboxgl-popup-tip {
    border-top-color: #1c1c1c !important;
}

/* ================= LEYENDA ================= */

.legend {
    font-size: 16px;
}

.legend span {
    width: 16px;
    height: 16px;
    display: inline-block;
    margin-right: 8px;
    border-radius: 4px;
}

/* ================= MODAL ================= */

#modalOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 999;
}

#modalBox {
    background: #1c1c1c;
    color: white;
    width: 92%;
    max-width: 1250px;
    max-height: 85vh;
    border-radius: 18px;
    padding: 30px;
    display: flex;
    flex-direction: column;
}

#modalTitle {
    text-align: center;
    margin: 0;
}

#modalContent {
    margin-top: 20px;
    overflow: auto;
    flex: 1;
}

#closeModal {
    cursor: pointer;
    font-size: 22px;
}

/* ================= TABLA ESTILO PYDECK ================= */

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

thead {
    background: #222;
    position: sticky;
    top: 0;
}

th {
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid #444;
    font-weight: 600;
}

td {
    padding: 9px;
    text-align: center; /* üî• AQU√ç SE CENTRAN TODOS LOS REGISTROS */
    border-bottom: 1px solid #1f1f1f;
}

tbody tr:nth-child(even) {
    background: #161616;
}

tbody tr:nth-child(odd) {
    background: #121212;
}

tbody tr:hover {
    background: #1f1f1f;
    transition: 0.2s;
}
</style>
</head>

<body>

<div id="panel">
    <div>
        <h2>BASE CONTROL PC 2026 PAE</h2>

        <p>
        <b>IIEE:</b> 67,055<br>
        <b>Usuarios:</b> 4,187,782<br>
        <b>√çtems:</b> 711
        </p>

        <hr>

        <p>
        <b>Estado:</b><br>
        ‚Ä¢ CONTRATO: 38%<br>
        ‚Ä¢ ADJUDICADO: 20%<br>
        ‚Ä¢ EN INVITACI√ìN: 43%
        </p>
    </div>

    <div class="legend">
        <b>Estado Mayoritario</b><br><br>
        <span style="background:#27AE60;"></span>Contrato<br>
        <span style="background:#F1C40F;"></span>Adjudicado<br>
        <span style="background:#E74C3C;"></span>Invitaci√≥n
    </div>
</div>

<div id="map"></div>

<div id="modalOverlay">
    <div id="modalBox">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="modalTitle"></h3>
            <span id="closeModal">‚úñ</span>
        </div>
        <div id="modalContent"></div>
    </div>
</div>

<script>

mapboxgl.accessToken = "pk.eyJ1IjoiMjAxODE3MjUiLCJhIjoiY21sanZ1NmdzMDQ5czNrcHFwdXBpN3o2eCJ9.lM43dWvXvojawo82gZFOIw";

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [-74.8, -9.3],
    zoom: 5.4
});

let popup;
let basePAE = [];

fetch('https://f1434408-oss.github.io/data-science-portfolio/base_pae.json')
    .then(res => res.json())
    .then(data => basePAE = data);

map.on('load', function () {

    map.getStyle().layers.forEach(layer => {
        if (layer.type === 'symbol') {
            map.setLayoutProperty(layer.id, 'visibility', 'none');
        }
    });

    map.setPaintProperty('water', 'fill-color', '#5dade2');

    map.addSource('departamentos', {
        type: 'geojson',
        data: 'geo_pae_departamental.geojson'
    });

    map.addSource('hover-departamento', {
        type: 'geojson',
        data: { type: "FeatureCollection", features: [] }
    });

    const colorExpression = [
        'case',
        ['>=', ['get', 'CONTRATO'], ['get', 'ADJUDICADO']], '#27AE60',
        ['>=', ['get', 'ADJUDICADO'], ['get', 'EN INVITACI√ìN']], '#F1C40F',
        '#E74C3C'
    ];

    map.addLayer({
        id: 'fill-layer',
        type: 'fill',
        source: 'departamentos',
        paint: { 'fill-color': colorExpression, 'fill-opacity': 0.85 }
    });

    map.addLayer({
        id: 'border-layer',
        type: 'line',
        source: 'departamentos',
        paint: { 'line-color': 'rgba(255,255,255,0.4)', 'line-width': 1.2 }
    });

    map.on('mouseenter', 'fill-layer', function (e) {

        const feature = e.features[0];

        if (popup) popup.remove();

        popup = new mapboxgl.Popup({ offset: 20 })
            .setLngLat(e.lngLat)
            .setHTML(`
                <b style="font-size:24px;">${feature.properties.NOMBDEP}</b>
                <hr style="opacity:0.3;">
                <b>√çtems:</b> ${feature.properties.ITEMS_TOTAL}<br><br>
                <a href="#" id="ver-detalle" style="color:#48a0ff; font-weight:bold;">
                Ver detalle completo</a>
            `)
            .addTo(map);

        document.getElementById('ver-detalle').addEventListener('click', function(evt){
            evt.preventDefault();
            abrirModalConTabla(feature.properties.NOMBDEP);
        });

    });

});

/* ================= MODAL ================= */

function abrirModalConTabla(departamento) {

    const datosFiltrados = basePAE.filter(item =>
        item.DEPARTAMENTO?.trim().toUpperCase() === departamento.trim().toUpperCase()
    );

    document.getElementById('modalTitle').innerText =
        "Detalle completo - " + departamento;

    if (datosFiltrados.length === 0) {
        document.getElementById('modalContent').innerHTML =
            "<p>No hay registros.</p>";
    } else {

        const columnasExcluir = ["MODALIDAD_SDC", "DEPARTAMENTO"];

        const columnas = Object.keys(datosFiltrados[0])
            .filter(col => !columnasExcluir.includes(col));

        function format(valor) {
            if (valor === null || valor === undefined) return "";
            if (!isNaN(valor) && valor !== "")
                return Number(valor).toLocaleString("en-US");
            return valor;
        }

        let tabla = "<table><thead><tr>";

        columnas.forEach(col => {
            tabla += `<th>${col}</th>`;
        });

        tabla += "</tr></thead><tbody>";

        datosFiltrados.forEach(row => {
            tabla += "<tr>";
            columnas.forEach(col => {
                tabla += `<td>${format(row[col])}</td>`;
            });
            tabla += "</tr>";
        });

        tabla += "</tbody></table>";

        document.getElementById('modalContent').innerHTML = tabla;
    }

    document.getElementById('modalOverlay').style.display = 'flex';
}

document.getElementById('closeModal').addEventListener('click', function() {
    document.getElementById('modalOverlay').style.display = 'none';
});

</script>

</body>
</html>